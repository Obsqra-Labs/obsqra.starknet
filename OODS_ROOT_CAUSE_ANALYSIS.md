# OODS Root Cause Analysis

**Date**: 2026-01-26  
**Status**: Comparing with Integrity examples to identify mismatch

---

## Key Finding: Layout/Builtin Mismatch

### Integrity Example (dex layout)
- **Layout**: `"dex"`
- **Builtins**: `ecdsa` (in memory_segments)
- **Structure**: Has `ecdsa` segment with begin_addr/stop_ptr

### Our Setup (recursive layout)
- **Layout**: `"recursive"` (from `INTEGRITY_LAYOUT`)
- **Builtins**: `bitwise` (we changed from `ecdsa` to `bitwise`)
- **Structure**: Should have `bitwise` segment, not `ecdsa`

---

## Public Input Structure Comparison

### Integrity Example Structure
```json
{
  "layout": "dex",
  "n_steps": 8192,
  "memory_segments": {
    "ecdsa": { "begin_addr": 9152, "stop_ptr": 9152 },
    "execution": { "begin_addr": 37, "stop_ptr": 5054 },
    "output": { "begin_addr": 5054, "stop_ptr": 5056 },
    "pedersen": { "begin_addr": 5056, "stop_ptr": 5056 },
    "program": { "begin_addr": 1, "stop_ptr": 5 },
    "range_check": { "begin_addr": 8128, "stop_ptr": 8128 }
  },
  "public_memory": [...],
  "rc_min": 0,
  "rc_max": 0,
  "dynamic_params": null
}
```

### Our Expected Structure (recursive + bitwise)
```json
{
  "layout": "recursive",
  "n_steps": <calculated>,
  "memory_segments": {
    "bitwise": { "begin_addr": X, "stop_ptr": Y },  // NOT ecdsa
    "execution": { "begin_addr": A, "stop_ptr": B },
    "output": { "begin_addr": C, "stop_ptr": D },
    "pedersen": { "begin_addr": E, "stop_ptr": F },
    "program": { "begin_addr": G, "stop_ptr": H },
    "range_check": { "begin_addr": I, "stop_ptr": J }
  },
  "public_memory": [...],
  "rc_min": <value>,
  "rc_max": <value>,
  "dynamic_params": null
}
```

---

## Hypothesis

**Root Cause**: Our public input is generated by `cairo-run` with `--layout recursive`, which should produce the correct structure with `bitwise` builtin. However, the Integrity verifier for `recursive` layout may be expecting a different AIR configuration or public input structure than what Stone's CPU AIR generates.

**Why OODS Fails**:
1. Stone generates proof using CPU AIR for CairoZero
2. Stone's CPU AIR expects canonical CairoZero public input format
3. Integrity's recursive layout verifier may expect different AIR/public input structure
4. Mismatch in AIR → different composition polynomial → OODS mismatch

---

## Next Steps

1. **Check Our Actual Public Input**: Run a test and capture the actual `risk_public.json` to see its structure
2. **Verify Layout Match**: Ensure our public input has `layout: "recursive"` and `bitwise` segment
3. **Compare with Recursive Example**: Find Integrity's recursive layout example (if exists)
4. **Test Small Layout**: Try `small` layout which may match Stone's CPU AIR better

---

## Critical Question

**Does Stone's CPU AIR support `recursive` layout, or only `small`/`dex`?**

Stone's CPU AIR is explicitly for CairoZero. The `recursive` layout may be a Cairo1/S-two concept that Stone's CPU AIR doesn't fully support, causing the AIR mismatch.

---

**Status**: Investigating layout/builtin mismatch between Stone's CPU AIR and Integrity's recursive layout expectations.
