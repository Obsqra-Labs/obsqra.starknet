# zkde.fi Setup

Setup for **zkde.fi by Obsqra Labs** — Starknet Sepolia app for privacy-preserving DeFi. Open source; lives at [zkde.fi](https://zkde.fi). For judges and privacy implementation choices (Garaga vs MIST.cash), see [FOR_JUDGES.md](FOR_JUDGES.md).

## Prerequisites

- [Scarb](https://docs.swmansion.com/scarb/) (Cairo/Starknet)
- [starkli](https://github.com/xJonathanLEI/starkli) or sncast (Foundry)
- Python 3.10+ (backend)
- Node.js 18+ (frontend)

## Contracts

### Build

```bash
cd contracts && scarb build
```

### Deploy to Sepolia

1. Set env vars (see [ENV.md](ENV.md)); create `backend/.env` and set `STARKNET_RPC_URL`, account env or `~/.starknet_accounts`.
2. Fund the deployer account on Sepolia.
3. **Fact registry**: Use the existing **Integrity** fact registry on Sepolia (Obsqra Labs prover submits proofs there). No mock registry; proofs are verified on-chain via Integrity.
4. **Token**: Use any ERC20 on Sepolia (e.g. deploy a simple ERC20 or use an existing test token). No mock token.
5. Deploy in order:
   - **ProofGatedYieldAgent** (fact_registry, token, admin) — fact_registry = Integrity address, token = ERC20 address.
   - **SelectiveDisclosure** (fact_registry, admin).
   - **Garaga Groth16 verifier**: build circuit in `circuits/`, run Garaga `garaga gen --system groth16_bn254 --vk <path>`, deploy generated Cairo verifier to Sepolia. Set `GARAGA_VERIFIER_ADDRESS`.
   - **ConfidentialTransfer** (garaga_verifier, token, admin). Set `CONFIDENTIAL_TRANSFER_ADDRESS`.
6. Proofs for deposit_with_proof/withdraw_with_proof are generated by the Obsqra prover (on Sepolia) and registered with Integrity; the contract checks `is_valid(proof_hash)` against Integrity. No test/mock facts.

Example with starkli/scarb:

```bash
cd contracts
export STARKNET_RPC_URL=https://starknet-sepolia.public.blastapi.io
scarb build
starkli deploy ...  # ProofGatedYieldAgent, SelectiveDisclosure, ConfidentialTransfer per Scarb output
```

Fill constructor args: Integrity fact registry address, ERC20 token address, admin. Update `.env` with deployed addresses.

## Backend

```bash
cd backend
python -m venv .venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows
pip install -r requirements.txt
export PORT=8003
uvicorn app.main:app --host 0.0.0.0 --port 8003
```

Set `.env` (or env) with `STARKNET_RPC_URL`, `OBSQRA_PROVER_API_URL`, `OBSQRA_API_KEY`, `PROOF_GATED_AGENT_ADDRESS`, `SELECTIVE_DISCLOSURE_ADDRESS`, `GARAGA_VERIFIER_ADDRESS`, and `CONFIDENTIAL_TRANSFER_ADDRESS`.

## Frontend

```bash
cd frontend
npm install
npm run dev
```

Runs on port 3001 by default. Set `NEXT_PUBLIC_API_URL` to backend URL (e.g. `http://localhost:8003`). For one-click flows: `NEXT_PUBLIC_PROOF_GATED_AGENT_ADDRESS` (Sign & deposit), `NEXT_PUBLIC_SELECTIVE_DISCLOSURE_ADDRESS` (Register on-chain), `NEXT_PUBLIC_CONFIDENTIAL_TRANSFER_ADDRESS` (Private tab).

## Reverse proxy (serve at zkde.fi)

To serve the app at **zkde.fi**:

- Route `/` (and app paths) to frontend (e.g. `http://127.0.0.1:3001`)
- Proxy `/api/v1/zkdefi` to backend (e.g. `http://127.0.0.1:8003`)

See [ARCHITECTURE.md](ARCHITECTURE.md) and [nginx.conf.example](nginx.conf.example) for a diagram and example config.
